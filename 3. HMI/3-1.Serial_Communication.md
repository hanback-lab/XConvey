
Auto 제어기를 통해 XConvey의 장치를 제어하거나 센서 데이터를 수집할 수 있습니다. Auto 제어기는 PC 혹은 HMI에 USB를 통해 연결됩니다. PC나 HMI에서는 시리얼 장치로 인식되며, 이를 통해 통신을 수행합니다. 여기서는 시리얼 통신을 기반으로 Auto 제어기와 통신을 수행하고 MQTT와 연동하여 XConvey의 센서 및 액추에이터를 연동합니다.

![](image/serialtomqtt.png)

필수 기능
Auto 제어기에서 수신된 데이터 혹은 Auto 제어기로 수신해야하는 데이터는 미리 정의된 프로토콜에 의해 데이터 송/수신을 합니다. 프로토콜의 내용은 2장의 "Protocol" 내용을 참조하시기 바랍니다.
구현할 기능의 요소를 정리하면 다음과 같이 정리할 수 있습니다.

Serial 통신
Auto 제어기와 PC 또는 HMI 간의 Serial 통신
센서 및 액추에이터의 피드백 데이터 수신
액추에이터 제어 데이터 송신
정의된 프로토콜에 따른 데이터 유효성 확인
MQTT 통신
토픽 송신
시리얼 통신을 통해 수신한 센서 및 액추에이터를 브로커에 토픽으로 발행
종류에 따른 JSON 포맷 활용
토픽 구독
브로커를 통해 구독한 토픽을 시리얼 통신을 통해 Auto 제어기로 송신
XHome MQTT 토픽
시리얼 통신을 통해 Auto 제어기에서 수신한 데이터 및 브로커를 통해 구독한 토픽을 Auto 제어기로 송신할 때 활용할 토픽을 정의합니다. 정의한 토픽의 구조는 다음과 같습니다.

토픽 구조
xconvey/{ID}/{PAYLOAD}
{ID} : 프로토콜 문서의 ID
{PAYLOAD} : 프로토콜 문서의 Data

다음 링크는 본 키트의 framework에서 구현중인 mqtt 를 subscribe 하여 데이터를 출력해보는 예제입니다.
https://github.com/hanback-lab/XConvey/blob/main/3.%20HMI/3-2.mqtt.md


# Serial 통신
Serial 통신은 대게 하나의 신호선을 이용하여 데이터를 주고받는 통신을 말합니다. 하나의 신호선을 이용하기 대문에 데이터 전송은 일정한 시간 간격으로 전송하게 됩니다. 즉 한 시간 간격 동안에 하나의 논리적인 데이터인 0과 1(High 혹은 Low)을 보냅니다. 시리얼통신은 적은 수의 신호선을 사용하기때문에 비용이 적게 들며 구현이 쉬운 장점이 있습니다. 대표적인 시리얼 통신은 USB, PC Comport 입니다.
파이썬에는 Serial 통신을 쉽게 사용할 수 있는 Pyserial 이 있습니다.


### Pyserial
PySerial은 파이썬에서 직렬 통신(serial communication)을 위한 라이브러리입니다. 이 라이브러리를 사용하면 파이썬 프로그램을 통해 컴퓨터가 다른 장치와 직렬 인터페이스를 통해 데이터를 주고받을 수 있습니다. 간단한 센서 데이터 읽기부터 복잡한 통신 프로토콜 구현까지 다양한 시리얼 통신 관련 작업을 쉽게 수행할 수 있습니다. 

컴퓨터와 센서, 다른 장치 간의 통신, UART (Universal Asynchronous Receiver/Transmitter) 등을 구현할 때 사용됩니다. 
PySerial은 직렬 포트 열기, 데이터 읽기/쓰기, 설정 변경 등 다양한 직렬 통신 관련 기능을 제공하며 간단한 API를 통해 쉽게 사용할 수 있습니다.
PySerial은 다음과 같이 시리얼 통신의 기능을 수행 할 수 있습니다.
센서 데이터 읽기:
센서에서 수집된 데이터를 컴퓨터로 전송받아 분석하거나 저장하는 프로그램 개발에 활용할 수 있습니다.
기기 제어:
로봇, 드론 등의 모터제어, 각종 센서 통합등에 사용될 수 있습니다.
통신 프로토콜 구현:
RS232, UART 등 다양한 통신 프로토콜을 구현하는 데 사용될 수 있습니다

#### Pyserial 설치
```out
$ sudo pip3 install pyserial
```
- Python 통신 예제소스

각 기기의 /dev/ttyS1, /dev/ttyS2 이 각각 연결된 것으로 가정하고 작성한 소스코드 입니다.

```python
import serial

#init serial port and bound
# bound rate on two ports must be the same
ser = serial.Serial('/dev/ttyS1', 9600)
print(ser.portstr)

#send data via serial port
ser.write("hello")
ser.close()


```

```python
import serial
serBarCode = serial.Serial('/dev/ttyS2', 9600, timeout=1)

while True:

    #read data from serial port
    serBarCode = serBarCode.readline()

    #if there is smth do smth
    if len(serBarCode) >= 1:
        print(dataBarCode.decode("utf-8"))
```
